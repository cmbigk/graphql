<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>My GraphQL Profile</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 20px;
  color: #333;
}

.login-box {
  max-width: 360px;
  margin: 80px auto;
  padding: 2rem;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.login-box h2 {
  margin-top: 0;
  margin-bottom: 1rem;
  text-align: center;
}
.login-box input {
  width: 100%;
  padding: 12px;
  margin-bottom: 1rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
.login-box button {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  color: #fff;
  background: #3b82f6;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.login-box button:hover {
  background: #2563eb;
}
.error {
  color: #b91c1c;
  margin-top: 8px;
  text-align: center;
}

.profile {
  max-width: 1200px;
  margin: auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}
.header h1 {
  margin: 0;
}
.header button {
  background: #ef4444;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}
.header button:hover {
  background: #dc2626;
}

.user-info {
  background: #fff;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  margin-bottom: 2rem;
}

.user-info h2 {
  margin: 0 0 1rem;
  color: #1f2937;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.info-item {
  padding: 0.75rem;
  background: #f8fafc;
  border-radius: 6px;
  border-left: 4px solid #3b82f6;
}

.info-item label {
  display: block;
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 0.25rem;
}

.info-item .value {
  font-size: 1.1rem;
  font-weight: 600;
  color: #1f2937;
}

.charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 2rem;
}

.chart-box {
  background: #fff;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.chart-box.full-width {
  grid-column: 1 / -1;
}

.chart-box h3 {
  margin: 0 0 1rem;
  font-size: 1.2rem;
  color: #1f2937;
}

.chart {
  overflow-x: auto;
}
.chart svg {
  display: block;
  margin: 0 auto;
}

.loading {
  text-align: center;
  padding: 20px;
  color: #666;
}

.projects-list {
  max-height: 300px;
  overflow-y: auto;
}

.project-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid #e5e7eb;
}

.project-item:last-child {
  border-bottom: none;
}

.project-name {
  font-weight: 500;
  color: #1f2937;
}

.project-xp {
  color: #059669;
  font-weight: 600;
}

.audit-stats {
  display: flex;
  justify-content: space-around;
  margin-top: 1rem;
}

.audit-stat {
  text-align: center;
  padding: 1rem;
  background: #f8fafc;
  border-radius: 6px;
  flex: 1;
  margin: 0 0.5rem;
}

.audit-stat .number {
  font-size: 1.5rem;
  font-weight: bold;
  color: #1f2937;
}

.audit-stat .label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 0.25rem;
}
</style>
</head>
<body>
<div class="login-box" id="login-container">
  <h2>Login</h2>
  <input id="username" placeholder="Username or Email" />
  <input id="password" type="password" placeholder="Password" />
  <button id="login-btn">Login & View Profile</button>
  <div id="error-msg" class="error"></div>
</div>

<div id="profile-container" class="profile" style="display:none;">
  <div class="header">
    <h1>Welcome, <span id="user-login"></span>!</h1>
    <button id="logout-btn">Logout</button>
  </div>
  
  <div class="user-info">
    <h2>Profile Information</h2>
    <div class="info-grid" id="user-info-grid">
      <div class="loading">Loading user information...</div>
    </div>
  </div>

  <div class="charts">
    <div class="chart-box">
      <h3>XP per Project (Top 10)</h3>
      <div id="xp-section" class="chart">
        <div class="loading">Loading...</div>
      </div>
    </div>
    
    <div class="chart-box">
      <h3>Audit Activity</h3>
      <div id="audit-section" class="chart">
        <div class="loading">Loading...</div>
      </div>
    </div>
    
    <div class="chart-box full-width">
      <h3>XP Progress Over Time</h3>
      <div id="timeline-section" class="chart">
        <div class="loading">Loading...</div>
      </div>
    </div>
    
    <div class="chart-box full-width">
      <h3>Completed Projects</h3>
      <div id="projects-section" class="projects-list">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
const GRAPHQL_ENDPOINT = "https://01.gritlab.ax/api/graphql-engine/v1/graphql";
const AUTH_ENDPOINT = "https://01.gritlab.ax/api/auth/signin";

async function login(username, password) {
  const res = await fetch(AUTH_ENDPOINT, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Basic " + btoa(`${username}:${password}`)
    }
  });

  if (!res.ok) {
    throw new Error(`Authentication failed: ${res.status} ${res.statusText}`);
  }

  let data;
  try {
    data = await res.json();
  } catch {
    data = await res.text();
  }

  if (typeof data === "string" && data.length > 100) {
    return data;
  }

  if (data.token || data.jwt) {
    return data.token || data.jwt;
  }

  throw new Error("No token received from authentication");
}

async function fetchUserData(jwt) {
  const query = `
  query {
    userInfo: user {
      id
      campus
      login
      email
      firstName
      lastName
      auditRatio
      totalUp
      totalDown
      createdAt
    }

    xpTransactions: transaction(
      where: {
        type: {_eq: "xp"}, 
        _and: [
          {object: {type: {_neq: "piscine"}}}, 
          {path: {_nlike: "%piscine-js/%"}}, 
          {path: {_nlike: "%checkpoint%"}}
        ]
      }
      order_by: {createdAt: asc}
    ) {
      amount
      path
      object {
        type
        name
      }
      createdAt
    }

    xpSum: transaction_aggregate(where: { type: { _eq: "xp" } }) {
      aggregate { 
        sum { 
          amount 
        } 
      }
    }

    auditsDone: audit_aggregate(where: { auditorId: { _is_null: false } }) {
      aggregate {
        count
      }
    }

    auditsReceived: audit_aggregate(where: { auditedId: { _is_null: false } }) {
      aggregate {
        count
      }
    }

    completedProjects: progress(
      where: { isDone: { _eq: true } }
      order_by: { updatedAt: desc }
    ) {
      object {
        name
        type
      }
      updatedAt
      grade
    }
  }`;

  const res = await fetch(GRAPHQL_ENDPOINT, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${jwt}`
    },
    body: JSON.stringify({query})
  });

  if (!res.ok) {
    throw new Error(`GraphQL request failed: ${res.status} ${res.statusText}`);
  }

  const result = await res.json();
  console.log("GraphQL response:", result);
  
  if (result.errors) {
    throw new Error(`GraphQL errors: ${result.errors.map(e => e.message).join(', ')}`);
  }

  return result.data;
}

function displayUserInfo(userData) {
  const user = userData.userInfo?.[0];
  if (!user) {
    document.getElementById("user-info-grid").innerHTML = 
      '<div style="text-align: center; color: #666;">User information not available</div>';
    return;
  }

  const totalXP = userData.xpSum?.aggregate?.sum?.amount || 0;
  const auditsDone = userData.auditsDone?.aggregate?.count || 0;
  const auditsReceived = userData.auditsReceived?.aggregate?.count || 0;
  const completedCount = userData.completedProjects?.length || 0;
  
  // Calculate level (assuming 1000 XP per level)
  const level = Math.floor(totalXP / 1000);
  const nextLevelXP = (level + 1) * 1000;
  const progressToNext = ((totalXP % 1000) / 1000) * 100;

  const joinDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Unknown';

  const infoHTML = `
    <div class="info-item">
      <label>Full Name</label>
      <div class="value">${user.firstName || ''} ${user.lastName || ''}</div>
    </div>
    <div class="info-item">
      <label>Email</label>
      <div class="value">${user.email || 'Not provided'}</div>
    </div>
    <div class="info-item">
      <label>Campus</label>
      <div class="value">${user.campus || 'Not specified'}</div>
    </div>
    <div class="info-item">
      <label>Join Date</label>
      <div class="value">${joinDate}</div>
    </div>
    <div class="info-item">
      <label>Total XP</label>
      <div class="value">${totalXP.toLocaleString()}</div>
    </div>
    <div class="info-item">
      <label>Current Level</label>
      <div class="value">${level} (${progressToNext.toFixed(1)}% to ${level + 1})</div>
    </div>
    <div class="info-item">
      <label>Audit Ratio</label>
      <div class="value">${user.auditRatio?.toFixed(2) || '0.00'}</div>
    </div>
    <div class="info-item">
      <label>Audits Done</label>
      <div class="value">${auditsDone}</div>
    </div>
    <div class="info-item">
      <label>Audits Received</label>
      <div class="value">${auditsReceived}</div>
    </div>
    <div class="info-item">
      <label>Completed Projects</label>
      <div class="value">${completedCount}</div>
    </div>
    <div class="info-item">
      <label>Total Up</label>
      <div class="value">${user.totalUp || 0}</div>
    </div>
    <div class="info-item">
      <label>Total Down</label>
      <div class="value">${user.totalDown || 0}</div>
    </div>
  `;

  document.getElementById("user-info-grid").innerHTML = infoHTML;
}

function groupXPByProject(transactions) {
  if (!transactions || !Array.isArray(transactions)) {
    return [];
  }
  
  const grouped = {};
  transactions.forEach(tx => {
    const name = tx.object?.name || "Unknown Project";
    grouped[name] = (grouped[name] || 0) + tx.amount;
  });
  
  return Object.entries(grouped)
    .map(([name, xp]) => ({ name, xp }))
    .sort((a,b) => b.xp - a.xp)
    .slice(0, 10);
}

function generateSVGBarChart(projects) {
  if (!projects || projects.length === 0) {
    return '<div style="text-align: center; padding: 20px; color: #666;">No XP data available</div>';
  }

  const barW = 60, gap = 10, chtH = 250;
  const maxXP = Math.max(...projects.map(p => p.xp), 1);
  
  const bars = projects.map((p, i) => {
    const h = Math.max((p.xp / maxXP) * 200, 2);
    const x = i * (barW + gap);
    const y = chtH - h;
    
    const displayName = p.name.length > 8 ? p.name.substring(0, 8) + '...' : p.name;
    
    return `
      <g>
        <rect x="${x}" y="${y}" width="${barW}" height="${h}" fill="#10b981" rx="4" />
        <text x="${x + barW/2}" y="${chtH + 15}" font-size="10" text-anchor="middle" fill="#333">${displayName}</text>
        <text x="${x + barW/2}" y="${y - 5}" font-size="10" text-anchor="middle" fill="#333">${p.xp}</text>
      </g>`;
  }).join("");
  
  const width = Math.max(projects.length * (barW + gap), 400);
  return `<svg width="100%" height="300" viewBox="0 0 ${width} 300">${bars}</svg>`;
}

function generateAuditChart(auditsDone, auditsReceived) {
  const maxAudits = Math.max(auditsDone, auditsReceived, 1);
  const barHeight = 40;
  const chartHeight = 120;
  
  const doneWidth = (auditsDone / maxAudits) * 300;
  const receivedWidth = (auditsReceived / maxAudits) * 300;
  
  return `
    <svg width="100%" height="${chartHeight}" viewBox="0 0 400 ${chartHeight}">
      <text x="0" y="20" font-size="12" fill="#333">Audits Done: ${auditsDone}</text>
      <rect x="0" y="25" width="${doneWidth}" height="${barHeight}" fill="#3b82f6" rx="4" />
      
      <text x="0" y="80" font-size="12" fill="#333">Audits Received: ${auditsReceived}</text>
      <rect x="0" y="85" width="${receivedWidth}" height="${barHeight}" fill="#10b981" rx="4" />
    </svg>`;
}

function generateXPTimeline(transactions) {
  if (!transactions || transactions.length === 0) {
    return '<div style="text-align: center; padding: 20px; color: #666;">No XP timeline data available</div>';
  }

  let cumulativeXP = 0;
  const timelineData = transactions.map(tx => {
    cumulativeXP += tx.amount;
    return {
      date: new Date(tx.createdAt),
      xp: cumulativeXP
    };
  });

  const width = 800;
  const height = 300;
  const padding = 40;
  
  const minDate = timelineData[0].date;
  const maxDate = timelineData[timelineData.length - 1].date;
  const maxXP = Math.max(...timelineData.map(d => d.xp));
  
  const dateRange = maxDate.getTime() - minDate.getTime();
  
  const points = timelineData.map(d => {
    const x = padding + ((d.date.getTime() - minDate.getTime()) / dateRange) * (width - 2 * padding);
    const y = height - padding - (d.xp / maxXP) * (height - 2 * padding);
    return `${x},${y}`;
  }).join(' ');
  
  const pathData = `M ${points.split(' ').join(' L ')}`;
  
  return `
    <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}">
      <defs>
        <linearGradient id="xpGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
          <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.1" />
        </linearGradient>
      </defs>
      
      <!-- Grid lines -->
      <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#e5e7eb" stroke-width="1"/>
      <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#e5e7eb" stroke-width="1"/>
      
      <!-- XP line -->
      <polyline points="${points}" fill="none" stroke="#3b82f6" stroke-width="2"/>
      
      <!-- Labels -->
      <text x="${padding}" y="${height - 10}" font-size="10" fill="#666">${minDate.toLocaleDateString()}</text>
      <text x="${width - padding - 60}" y="${height - 10}" font-size="10" fill="#666">${maxDate.toLocaleDateString()}</text>
      <text x="10" y="${padding}" font-size="10" fill="#666">${maxXP.toLocaleString()}</text>
      <text x="10" y="${height - padding}" font-size="10" fill="#666">0</text>
    </svg>`;
}

function displayCompletedProjects(projects) {
  if (!projects || projects.length === 0) {
    document.getElementById("projects-section").innerHTML = 
      '<div style="text-align: center; padding: 20px; color: #666;">No completed projects found</div>';
    return;
  }

  const projectsHTML = projects.map(project => {
    const completedDate = new Date(project.updatedAt).toLocaleDateString();
    const grade = project.grade || 0;
    const gradeColor = grade >= 100 ? '#059669' : '#dc2626';
    
    return `
      <div class="project-item">
        <div>
          <div class="project-name">${project.object?.name || 'Unknown Project'}</div>
          <div style="font-size: 0.875rem; color: #6b7280;">Completed: ${completedDate}</div>
        </div>
        <div style="color: ${gradeColor}; font-weight: 600;">${grade}%</div>
      </div>`;
  }).join('');

  document.getElementById("projects-section").innerHTML = projectsHTML;
}

async function handleLogin() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  const errorMsg = document.getElementById("error-msg");
  const loginBtn = document.getElementById("login-btn");
  
  errorMsg.textContent = "";

  if (!username || !password) {
    errorMsg.textContent = "Please enter both username and password";
    return;
  }

  loginBtn.textContent = "Logging in...";
  loginBtn.disabled = true;

  try {
    console.log("Attempting login...");
    const jwt = await login(username, password);
    console.log("Login successful, JWT received");

    const userData = await fetchUserData(jwt);
    console.log("User data fetched:", userData);
    
    // Display user info
    const displayName = userData.userInfo?.[0]?.login || 
                       userData.userInfo?.[0]?.firstName || 
                       username;
    document.getElementById("user-login").textContent = displayName;

    // Display user information
    displayUserInfo(userData);

    // Generate XP chart
    const xpProjects = groupXPByProject(userData.xpTransactions);
    document.getElementById("xp-section").innerHTML = generateSVGBarChart(xpProjects);

    // Generate audit chart
    const auditsDone = userData.auditsDone?.aggregate?.count || 0;
    const auditsReceived = userData.auditsReceived?.aggregate?.count || 0;
    document.getElementById("audit-section").innerHTML = generateAuditChart(auditsDone, auditsReceived);

    // Generate XP timeline
    document.getElementById("timeline-section").innerHTML = generateXPTimeline(userData.xpTransactions);

    // Display completed projects
    displayCompletedProjects(userData.completedProjects);

    // Show profile, hide login
    document.getElementById("login-container").style.display = "none";
    document.getElementById("profile-container").style.display = "block";
    
  } catch (err) {
    console.error("Login error:", err);
    errorMsg.textContent = "Login failed: " + err.message;
  } finally {
    loginBtn.textContent = "Login & View Profile";
    loginBtn.disabled = false;
  }
}

function logout() {
  document.getElementById("login-container").style.display = "block";
  document.getElementById("profile-container").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("error-msg").textContent = "";
}

// Event listeners
document.getElementById("login-btn").addEventListener("click", handleLogin);
document.getElementById("logout-btn").addEventListener("click", logout);

// Allow Enter key to trigger login
document.getElementById("username").addEventListener("keypress", function(e) {
  if (e.key === "Enter") handleLogin();
});
document.getElementById("password").addEventListener("keypress", function(e) {
  if (e.key === "Enter") handleLogin();
});
</script>
</body>
</html>