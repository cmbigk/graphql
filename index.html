<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>My GraphQL Profile</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 20px;
  color: #333;
}

.login-box {
  max-width: 360px;
  margin: 80px auto;
  padding: 2rem;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.login-box h2 {
  margin-top: 0;
  margin-bottom: 1rem;
  text-align: center;
}
.login-box input {
  width: 100%;
  padding: 12px;
  margin-bottom: 1rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
.login-box button {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  color: #fff;
  background: #3b82f6;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.login-box button:hover {
  background: #2563eb;
}
.error {
  color: #b91c1c;
  margin-top: 8px;
  text-align: center;
}

.profile {
  max-width: 1200px;
  margin: auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}
.header h1 {
  margin: 0;
  font-size: 2rem;
}
.header button {
  background: #ef4444;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}
.header button:hover {
  background: #dc2626;
}

.info-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-bottom: 2rem;
}

.info-box {
  background: #fff;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.info-box h2 {
  margin: 0 0 1rem;
  font-size: 1.5rem;
  color: #1f2937;
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 0.5rem;
}

.info-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.75rem;
  padding: 0.5rem 0;
  border-bottom: 1px solid #f3f4f6;
}

.info-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.info-label {
  font-weight: bold;
  color: #374151;
}

.info-value {
  color: #6b7280;
  text-align: right;
}

.charts {
  display: flex;
  flex-wrap: wrap;
  gap: 2rem;
}
.chart-box {
  flex: 1;
  min-width: 400px;
  background: #fff;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.chart-box h3 {
  margin: 0 0 1rem;
  font-size: 1.2rem;
  color: #1f2937;
}

.chart {
  overflow-x: auto;
}
.chart svg {
  display: block;
  margin: 0 auto;
}

.loading {
  text-align: center;
  padding: 20px;
  color: #666;
}

@media (max-width: 768px) {
  .info-section {
    grid-template-columns: 1fr;
  }
  .chart-box {
    min-width: 280px;
  }
}
</style>
</head>
<body>
<div class="login-box" id="login-container">
  <h2>Login</h2>
  <input id="username" placeholder="Username or Email" />
  <input id="password" type="password" placeholder="Password" />
  <button id="login-btn">Login & View Profile</button>
  <div id="error-msg" class="error"></div>
</div>

<div id="profile-container" class="profile" style="display:none;">
  <div class="header">
    <h1>Welcome, <span id="user-login"></span>!</h1>
    <button id="logout-btn">Logout</button>
  </div>
  
  <div class="info-section">
    <div class="info-box">
      <h2>User's Information</h2>
      <div class="info-item">
        <span class="info-label">Campus:</span>
        <span class="info-value" id="user-campus">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">ID:</span>
        <span class="info-value" id="user-id">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">First Name:</span>
        <span class="info-value" id="user-firstname">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Last Name:</span>
        <span class="info-value" id="user-lastname">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Email:</span>
        <span class="info-value" id="user-email">-</span>
      </div>
    </div>
    
    <div class="info-box">
      <h2>Course Progress</h2>
      <div class="info-item">
        <span class="info-label">Total XP:</span>
        <span class="info-value" id="user-totalxp">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Audit Ratio:</span>
        <span class="info-value" id="user-auditratio">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Done:</span>
        <span class="info-value" id="user-totalup">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Bonus:</span>
        <span class="info-value" id="user-bonus">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Received:</span>
        <span class="info-value" id="user-totaldown">-</span>
      </div>
    </div>
  </div>
  
  <div class="charts">
    <div class="chart-box">
      <h3>XP per Project</h3>
      <div id="xp-project-section" class="chart">
        <div class="loading">Loading...</div>
      </div>
    </div>
    <div class="chart-box">
      <h3>XP per Exercise</h3>
      <div id="xp-exercise-section" class="chart">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
const GRAPHQL_ENDPOINT = "https://01.gritlab.ax/api/graphql-engine/v1/graphql";
const AUTH_ENDPOINT = "https://01.gritlab.ax/api/auth/signin";

async function login(username, password) {
  const res = await fetch(AUTH_ENDPOINT, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Basic " + btoa(`${username}:${password}`)
    }
  });

  if (!res.ok) {
    throw new Error(`Authentication failed: ${res.status} ${res.statusText}`);
  }

  let data;
  try {
    data = await res.json();
  } catch {
    data = await res.text();
  }

  if (typeof data === "string" && data.length > 100) {
    return data;
  }

  if (data.token || data.jwt) {
    return data.token || data.jwt;
  }

  throw new Error("No token received from authentication");
}

async function fetchUserAndXPData(jwt) {
  const query = `
  query {
    userInfo: user {
      id
      campus
      login
      email
      firstName
      lastName
      auditRatio
      totalUp
      totalUpBonus
      totalDown
    }

    xpTransactions: transaction(
      where: {
        type: {_eq: "xp"}, 
        _and: [
          {object: {type: {_neq: "piscine"}}}, 
          {path: {_nlike: "%piscine-js/%"}}, 
          {path: {_nlike: "%checkpoint%"}}
        ]
      }
      order_by: {createdAt: asc}
    ) {
      amount
      path
      object {
        type
        name
      }
      createdAt
    }

    xpSum: transaction_aggregate(where: { type: { _eq: "xp" } }) {
      aggregate { 
        sum { 
          amount 
        } 
      }
    }
  }`;

  const res = await fetch(GRAPHQL_ENDPOINT, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${jwt}`
    },
    body: JSON.stringify({query})
  });

  if (!res.ok) {
    throw new Error(`GraphQL request failed: ${res.status} ${res.statusText}`);
  }

  const result = await res.json();
  console.log("GraphQL response:", result);
  
  if (result.errors) {
    throw new Error(`GraphQL errors: ${result.errors.map(e => e.message).join(', ')}`);
  }

  return result.data;
}

function populateUserInfo(userInfo, totalXP) {
  const user = userInfo?.[0];
  if (!user) return;

  document.getElementById("user-campus").textContent = user.campus || "-";
  document.getElementById("user-id").textContent = user.id || "-";
  document.getElementById("user-firstname").textContent = user.firstName || "-";
  document.getElementById("user-lastname").textContent = user.lastName || "-";
  document.getElementById("user-email").textContent = user.email || "-";
  document.getElementById("user-totalxp").textContent = totalXP ? `${totalXP.toLocaleString()} XP` : "-";
  document.getElementById("user-auditratio").textContent = user.auditRatio ? user.auditRatio.toFixed(2) : "-";
  document.getElementById("user-totalup").textContent = user.totalUp ? `${user.totalUp.toLocaleString()} bytes` : "-";
  document.getElementById("user-bonus").textContent = user.totalUpBonus ? `${user.totalUpBonus.toLocaleString()} bytes` : "-";
  document.getElementById("user-totaldown").textContent = user.totalDown ? `${user.totalDown.toLocaleString()} bytes` : "-";
}

function groupXPByProject(transactions) {
  if (!transactions || !Array.isArray(transactions)) {
    console.warn("No transactions data available");
    return [];
  }
  
  const grouped = {};
  transactions.forEach(tx => {
    if (tx.object?.type === "project") {
      const name = tx.object?.name || "Unknown Project";
      grouped[name] = (grouped[name] || 0) + tx.amount;
    }
  });
  
  return Object.entries(grouped)
    .map(([name, xp]) => ({ name, xp }))
    .sort((a,b) => b.xp - a.xp)
    .slice(0, 10);
}

function groupXPByExercise(transactions) {
  if (!transactions || !Array.isArray(transactions)) {
    console.warn("No transactions data available");
    return [];
  }
  
  const grouped = {};
  transactions.forEach(tx => {
    if (tx.object?.type === "exam" || tx.object?.type === "exercise") {
      const name = tx.object?.name || "Unknown Exercise";
      grouped[name] = (grouped[name]||0) + tx.amount;
    }
  });
  
  return Object.entries(grouped)
    .map(([name, xp]) => ({ name, xp }))
    .sort((a,b) => b.xp - a.xp)
    .slice(0, 10);
}

function generateSVGBarChart(items, color = "#10b981") {
  if (!items || items.length === 0) {
    return '<div style="text-align: center; padding: 20px; color: #666;">No data available</div>';
  }

  const barW = 60, gap = 10, chtH = 250;
  const maxXP = Math.max(...items.map(p => p.xp), 1);
  
  const bars = items.map((p, i) => {
    const h = Math.max((p.xp / maxXP) * 200, 2);
    const x = i * (barW + gap);
    const y = chtH - h;
    
    const displayName = p.name.length > 8 ? p.name.substring(0, 8) + '...' : p.name;
    
    return `
      <g>
        <rect x="${x}" y="${y}" width="${barW}" height="${h}" fill="${color}" rx="4" />
        <text x="${x + barW/2}" y="${chtH + 15}" font-size="10" text-anchor="middle" fill="#333">${displayName}</text>
        <text x="${x + barW/2}" y="${y - 5}" font-size="10" text-anchor="middle" fill="#333">${p.xp}</text>
      </g>`;
  }).join("");
  
  const width = Math.max(items.length * (barW + gap), 400);
  return `<svg width="100%" height="300" viewBox="0 0 ${width} 300">${bars}</svg>`;
}

async function handleLogin() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  const errorMsg = document.getElementById("error-msg");
  const loginBtn = document.getElementById("login-btn");
  
  errorMsg.textContent = "";

  if (!username || !password) {
    errorMsg.textContent = "Please enter both username and password";
    return;
  }

  loginBtn.textContent = "Logging in...";
  loginBtn.disabled = true;

  try {
    console.log("Attempting login...");
    const jwt = await login(username, password);
    console.log("Login successful, JWT received");

    const userData = await fetchUserAndXPData(jwt);
    console.log("User data fetched:", userData);
    
    // Display user info
    const displayName = userData.userInfo?.[0]?.login || 
                       userData.userInfo?.[0]?.firstName || 
                       username;
    document.getElementById("user-login").textContent = displayName;

    // Populate user information
    const totalXP = userData.xpSum?.aggregate?.sum?.amount || 0;
    populateUserInfo(userData.userInfo, totalXP);

    // Generate charts
    const xpProjects = groupXPByProject(userData.xpTransactions);
    document.getElementById("xp-project-section").innerHTML = 
      generateSVGBarChart(xpProjects, "#3b82f6");

    const xpExercises = groupXPByExercise(userData.xpTransactions);
    document.getElementById("xp-exercise-section").innerHTML = 
      generateSVGBarChart(xpExercises, "#10b981");

    // Show profile, hide login
    document.getElementById("login-container").style.display = "none";
    document.getElementById("profile-container").style.display = "block";
    
  } catch (err) {
    console.error("Login error:", err);
    errorMsg.textContent = "Login failed: " + err.message;
  } finally {
    loginBtn.textContent = "Login & View Profile";
    loginBtn.disabled = false;
  }
}

function logout() {
  document.getElementById("login-container").style.display = "block";
  document.getElementById("profile-container").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("error-msg").textContent = "";
}

// Event listeners
document.getElementById("login-btn").addEventListener("click", handleLogin);
document.getElementById("logout-btn").addEventListener("click", logout);

document.getElementById("username").addEventListener("keypress", function(e) {
  if (e.key === "Enter") handleLogin();
});
document.getElementById("password").addEventListener("keypress", function(e) {
  if (e.key === "Enter") handleLogin();
});
</script>
</body>
</html>